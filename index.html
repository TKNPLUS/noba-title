<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTuberã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ã‚¤ã‚º</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg overflow-hidden p-6">
        
        <header class="mb-6 text-center border-b pb-4">
            <h1 class="text-2xl font-bold text-red-600">YouTube ã‚µãƒ ãƒã‚¤ãƒ«ã‚¯ã‚¤ã‚º</h1>
            <p class="text-sm text-gray-500 mt-1">ã‚µãƒ ãƒã‚’è¦‹ã¦å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚’å½“ã¦ã‚ˆã†ï¼</p>
        </header>

        <div id="loading-screen" class="text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
            <p>ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <div id="error-screen" class="hidden text-center py-10 text-red-600">
            <p id="error-message">ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>
            <p class="text-sm mt-2 text-gray-500">csvãƒ•ã‚¡ã‚¤ãƒ«ãŒåŒã˜ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>
        </div>

        <div id="start-screen" class="hidden fade-in space-y-6">
            <button onclick="openSettingsModal()" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 rounded-lg shadow transition mb-4">
                âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†
            </button>
            
            <div class="bg-blue-50 p-4 rounded-lg">
                <h2 class="font-bold mb-2">â‘  å‡ºé¡Œç¯„å›²ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰</h2>
                <input type="range" id="rank-range" min="10" max="100" value="50" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-sm mt-1">
                    <span>ä¸Šä½10% (æœ‰å)</span>
                    <span id="rank-value" class="font-bold text-blue-600">ä¸Šä½ 50%</span>
                    <span>100% (ãƒãƒ‹ã‚¢)</span>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    å¯¾è±¡å‹•ç”»æ•°: <span id="video-count-display">0</span> æœ¬ / å…¨ <span id="total-video-count">0</span> æœ¬
                </p>
            </div>

            <div class="bg-green-50 p-4 rounded-lg">
                <h2 class="font-bold mb-2">â‘¡ ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h2>
                <div class="grid grid-cols-2 gap-2">
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" name="mode" value="normal" checked class="form-radio text-green-600">
                        <span>é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ (4æŠ)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" name="mode" value="hard" class="form-radio text-red-600">
                        <span>ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ (å…¥åŠ›)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" id="mode-reverse" name="mode" value="reverse" class="form-radio text-purple-600">
                        <span>é€†ã‚¯ã‚¤ã‚º (ã‚¿ã‚¤ãƒˆãƒ«â†’ã‚µãƒ ãƒ)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" id="mode-highlow" name="mode" value="highlow" class="form-radio text-blue-600">
                        <span>ãƒã‚¤ï¼†ãƒ­ãƒ¼ (å†ç”Ÿæ•°å½“ã¦)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" name="mode" value="viewcount" class="form-radio text-yellow-600">
                        <span>å†ç”Ÿæ•°äºˆæƒ³ (ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" name="mode" value="zoom" class="form-radio text-pink-600">
                        <span>ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ (éƒ¨åˆ†æ‹¡å¤§)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" name="mode" value="blur" class="form-radio text-indigo-600">
                        <span>ã¼ã‹ã—ãƒ¢ãƒ¼ãƒ‰ (å¾ã€…ã«é®®æ˜)</span>
                    </label>
                </div>
            </div>

            <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition transform hover:scale-105">
                ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ
            </button>
        </div>

        <div id="quiz-screen" class="hidden fade-in">
            <div class="mb-4 flex justify-between items-center text-sm text-gray-500">
                <span id="quiz-rank-info">Rank: ???</span>
                <span class="bg-gray-200 px-2 py-1 rounded">View: <span id="quiz-view-count">0</span></span>
            </div>

            <div class="flex justify-center mb-6">
                <img id="quiz-image" src="" alt="Thumbnail" class="rounded-lg shadow-md max-h-64 object-cover border-2 border-gray-200">
            </div>

            <!-- é€†ã‚¯ã‚¤ã‚ºç”¨ï¼šã‚¿ã‚¤ãƒˆãƒ«è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="quiz-title-display" class="hidden text-center mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-300">
                <p class="text-xs text-gray-500 mb-2">ã“ã®ã‚¿ã‚¤ãƒˆãƒ«ã®å‹•ç”»ã¯ã©ã‚Œï¼Ÿ</p>
                <p class="font-bold text-lg"></p>
            </div>

            <div id="normal-options" class="grid grid-cols-1 gap-3">
                </div>

            <div id="hard-input-area" class="hidden flex flex-col gap-3">
                <input type="text" id="title-input" placeholder="å‹•ç”»ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›..." class="border-2 border-gray-300 p-3 rounded-lg w-full focus:outline-none focus:border-red-500">
                <button onclick="checkHardAnswer()" class="bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700">å›ç­”ã™ã‚‹</button>
                <p class="text-xs text-gray-400 text-center">â€»ã‚¹ãƒšãƒ¼ã‚¹ã‚„å¤§æ–‡å­—å°æ–‡å­—ã¯ç„¡è¦–ã•ã‚Œã¾ã™</p>
            </div>

            <!-- é€†ã‚¯ã‚¤ã‚ºç”¨ï¼šã‚µãƒ ãƒã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ -->
            <div id="reverse-options" class="hidden grid grid-cols-2 gap-4">
            </div>

            <!-- ãƒã‚¤ï¼†ãƒ­ãƒ¼ç”¨ï¼š2ã¤ã®å‹•ç”»æ¯”è¼ƒã‚¨ãƒªã‚¢ -->
            <div id="highlow-container" class="hidden space-y-4">
                <div class="text-center font-bold text-lg mb-4">ã©ã¡ã‚‰ã®å†ç”Ÿæ•°ãŒå¤šã„ï¼Ÿ</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="cursor-pointer border-2 border-gray-300 hover:border-blue-500 rounded-lg p-4 transition" onclick="checkHighLowAnswer(1)">
                        <img id="highlow-video1-thumb" src="" alt="ã‚µãƒ ãƒ1" class="w-full rounded mb-2">
                        <p id="highlow-video1-title" class="text-sm font-medium text-center"></p>
                    </div>
                    <div class="cursor-pointer border-2 border-gray-300 hover:border-blue-500 rounded-lg p-4 transition" onclick="checkHighLowAnswer(2)">
                        <img id="highlow-video2-thumb" src="" alt="ã‚µãƒ ãƒ2" class="w-full rounded mb-2">
                        <p id="highlow-video2-title" class="text-sm font-medium text-center"></p>
                    </div>
                </div>
            </div>

            <!-- å†ç”Ÿæ•°äºˆæƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¨ãƒªã‚¢ -->
            <div id="viewcount-container" class="hidden space-y-4">
                <div class="text-center mb-4">
                    <p class="font-bold text-lg mb-2">ã“ã®å‹•ç”»ã®å†ç”Ÿæ•°ã¯ï¼Ÿ</p>
                    <p class="text-sm text-gray-500">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§äºˆæƒ³ã—ã¦ãã ã•ã„ï¼ˆèª¤å·® Â±10ä¸‡å›ä»¥å†…ã§æ­£è§£ï¼‰</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <input type="range" id="viewcount-slider" min="0" max="10000000" step="10000" value="1000000" class="w-full h-3 bg-yellow-200 rounded-lg appearance-none cursor-pointer">
                    <div class="text-center mt-2">
                        <span class="text-2xl font-bold text-yellow-600" id="viewcount-display">1,000,000</span>
                        <span class="text-sm text-gray-600 ml-1">å›</span>
                    </div>
                </div>
                <button onclick="checkViewCountAnswer()" class="w-full bg-yellow-600 text-white font-bold py-3 rounded-lg hover:bg-yellow-700">å›ç­”ã™ã‚‹</button>
            </div>

            <!-- ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šæ‹¡å¤§è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="zoom-container" class="hidden">
                <div class="flex justify-center mb-6 overflow-hidden">
                    <div id="zoom-viewport" style="width: 320px; height: 180px; position: relative; overflow: hidden; border: 2px solid #e5e7eb; border-radius: 8px;">
                        <img id="zoom-image" src="" alt="å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«ã®æ‹¡å¤§éƒ¨åˆ†" style="position: absolute;">
                    </div>
                </div>
            </div>

            <!-- ã¼ã‹ã—ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼šã¼ã‹ã—ç”»åƒã‚¨ãƒªã‚¢ -->
            <div id="blur-container" class="hidden">
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-500">æ™‚é–“çµŒé: <span id="blur-timer">0</span>ç§’ / å¾ã€…ã«é®®æ˜ã«ãªã‚Šã¾ã™</p>
                </div>
                <div class="flex justify-center mb-6">
                    <img id="blur-image" src="" alt="å¾ã€…ã«é®®æ˜ã«ãªã‚‹å‹•ç”»ã‚µãƒ ãƒã‚¤ãƒ«" class="rounded-lg shadow-md max-h-64 object-cover border-2 border-gray-200" style="filter: blur(50px);">
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden fade-in text-center">
            <h2 id="result-message" class="text-3xl font-bold mb-4"></h2>
            
            <!-- èª¤ç­”ã®å ´åˆï¼šé¸æŠã—ãŸå‹•ç”»ã‚’è¡¨ç¤º -->
            <div id="wrong-answer-section" class="hidden bg-red-50 p-4 rounded-lg mb-4 text-left border-2 border-red-200">
                <p class="text-xs text-gray-500 mb-1">ã‚ãªãŸã®å›ç­”</p>
                <img id="wrong-answer-thumbnail" src="" alt="é¸æŠã—ãŸä¸æ­£è§£å‹•ç”»ã®ã‚µãƒ ãƒã‚¤ãƒ«" class="w-full max-w-xs mx-auto rounded mb-2">
                <p id="wrong-answer-title" class="font-bold text-lg mb-2 text-gray-900"></p>
                <a id="wrong-answer-link" href="#" target="_blank" class="text-blue-600 underline text-sm hover:text-blue-800 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                    YouTubeã§è¦‹ã‚‹
                </a>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                <p class="text-xs text-gray-500 mb-1">æ­£è§£ã®å‹•ç”»</p>
                <img id="result-thumbnail" src="" alt="æ­£è§£å‹•ç”»ã®ã‚µãƒ ãƒã‚¤ãƒ«" class="w-full max-w-xs mx-auto rounded mb-2">
                <p id="result-title" class="font-bold text-lg mb-2 text-gray-900"></p>
                <div id="result-detail" class="mb-2"></div>
                <a id="result-link" href="#" target="_blank" class="text-blue-600 underline text-sm hover:text-blue-800 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                    YouTubeã§è¦‹ã‚‹
                </a>
            </div>

            <div class="flex gap-4">
                <button onclick="backToMenu()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">
                    ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
                </button>
                <button onclick="nextQuestion()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">
                    æ¬¡ã®å•é¡Œ
                </button>
            </div>
        </div>

    </div>

    <!-- è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h2 class="text-2xl font-bold text-gray-800">âš™ï¸ è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>

            <!-- ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ -->
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold mb-2 text-blue-900">ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠ</h3>
                <select id="data-source-select" onchange="onDataSourceChange()" class="w-full border-2 border-blue-300 p-2 rounded-lg focus:outline-none focus:border-blue-500">
                    <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯manifest.jsonã‹ã‚‰è‡ªå‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã™ -->
                </select>
                <p class="text-xs text-gray-600 mt-2">ãƒ—ãƒªã‚»ãƒƒãƒˆã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã¾ãŸã¯ç”Ÿæˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠ</p>
            </div>

            <!-- YouTube Data API ãƒ‡ãƒ¼ã‚¿å–å¾— -->
            <div class="mb-6 bg-red-50 p-4 rounded-lg">
                <h3 class="font-bold mb-3 text-red-900">ğŸ“¥ YouTube Data API ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—</h3>
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">API Key</label>
                        <input type="text" id="api-key-input" placeholder="YouTube Data API v3 ã‚­ãƒ¼ã‚’å…¥åŠ›" class="w-full border-2 border-gray-300 p-2 rounded-lg focus:outline-none focus:border-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Channel ID</label>
                        <input type="text" id="channel-id-input" placeholder="ãƒãƒ£ãƒ³ãƒãƒ«IDã‚’å…¥åŠ›" class="w-full border-2 border-gray-300 p-2 rounded-lg focus:outline-none focus:border-red-500">
                    </div>
                    <div>
                        <label class="flex items-center gap-2">
                            <input type="checkbox" id="exclude-shorts-checkbox" checked class="form-checkbox text-red-600">
                            <span class="text-sm">Shortsã‚’é™¤å¤– (60ç§’ä»¥ä¸‹ & #shortså«ã‚€)</span>
                        </label>
                    </div>
                    <button onclick="fetchYouTubeData()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">
                        ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹
                    </button>
                    <div id="fetch-status" class="text-sm text-gray-600 hidden"></div>
                </div>
            </div>

            <!-- CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ -->
            <div class="mb-6 bg-green-50 p-4 rounded-lg">
                <h3 class="font-bold mb-3 text-green-900">ğŸ“ CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
                <input type="file" id="csv-file-input" accept=".csv" onchange="importCSVFile()" class="w-full border-2 border-green-300 p-2 rounded-lg">
                <p class="text-xs text-gray-600 mt-2">ãƒ­ãƒ¼ã‚«ãƒ«ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿</p>
            </div>

            <!-- CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ -->
            <div class="mb-4 bg-yellow-50 p-4 rounded-lg">
                <h3 class="font-bold mb-3 text-yellow-900">ğŸ’¾ ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
                <button onclick="exportCurrentCSV()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 rounded-lg">
                    CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®š
        let CSV_FILE = 'datas/nobamangames.csv';
        
        // ã‚²ãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰è¨­å®šå®šæ•°
        const VIEWCOUNT_MARGIN = 100000; // å†ç”Ÿæ•°äºˆæƒ³ã®è¨±å®¹èª¤å·®ï¼ˆÂ±10ä¸‡å›ï¼‰
        const SLIDER_MAX_MULTIPLIER = 1.5; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æœ€å¤§å€¤å€ç‡
        const SLIDER_INITIAL_DIVISOR = 2; // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®åˆæœŸå€¤é™¤æ•°
        const THUMBNAIL_WIDTH = 320;
        const THUMBNAIL_HEIGHT = 180;
        const ZOOM_SCALE = 3; // ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã®æ‹¡å¤§ç‡
        const BLUR_INITIAL = 50; // ã¼ã‹ã—ãƒ¢ãƒ¼ãƒ‰åˆæœŸå€¤ï¼ˆpxï¼‰
        const BLUR_DURATION = 20; // ã¼ã‹ã—ãŒå®Œå…¨ã«å–ã‚Œã‚‹ã¾ã§ã®ç§’æ•°
        const BLUR_STEP = BLUR_INITIAL / BLUR_DURATION; // 1ç§’ã‚ãŸã‚Šã®ã¼ã‹ã—æ¸›å°‘é‡
        
        // çŠ¶æ…‹å¤‰æ•°
        let allVideos = [];
        let filteredVideos = [];
        let currentVideo = null;
        let currentVideo2 = null; // ãƒã‚¤ï¼†ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ç”¨
        let selectedVideo = null; // é¸æŠã•ã‚ŒãŸå‹•ç”»ï¼ˆèª¤ç­”æ™‚ã«è¡¨ç¤ºç”¨ï¼‰
        let currentMode = 'normal';
        let blurTimer = null; // ã¼ã‹ã—ãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¿ã‚¤ãƒãƒ¼
        let blurSeconds = 0; // ã¼ã‹ã—ãƒ¢ãƒ¼ãƒ‰çµŒéæ™‚é–“
        let maxViewCount = 0; // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿å‹•ç”»ã®æœ€å¤§å†ç”Ÿæ•°ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
        
        // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”¨çŠ¶æ…‹å¤‰æ•°
        let generatedCSVs = []; // ç”Ÿæˆã—ãŸCSVãƒ‡ãƒ¼ã‚¿ã®é…åˆ— [{name, data}]
        let currentDataSource = 'nobamangames.csv'; // ç¾åœ¨é¸æŠä¸­ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å
        let availableCSVFiles = []; // datasãƒ•ã‚©ãƒ«ãƒ€å†…ã®åˆ©ç”¨å¯èƒ½ãªCSVãƒ•ã‚¡ã‚¤ãƒ«
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ›´æ–°é–¢æ•°ï¼ˆå†åˆ©ç”¨ã®ãŸã‚å¤–éƒ¨ã«å®šç¾©ï¼‰
        function updateViewCountDisplay() {
            const slider = document.getElementById('viewcount-slider');
            const display = document.getElementById('viewcount-display');
            if (slider && display) {
                display.innerText = parseInt(slider.value).toLocaleString();
            }
        }

        // DOMè¦ç´ 
        const screens = {
            loading: document.getElementById('loading-screen'),
            error: document.getElementById('error-screen'),
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };

        // åˆæœŸåŒ–ï¼šmanifestèª­ã¿è¾¼ã¿å¾Œã«CSVèª­ã¿è¾¼ã¿
        window.onload = function() {
            loadManifest();
        };

        function showError(msg) {
            screens.loading.classList.add('hidden');
            screens.error.classList.remove('hidden');
            document.getElementById('error-message').innerText = msg;
        }

        function switchScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åˆæœŸåŒ–
        function initMenu() {
            const total = allVideos.length;
            document.getElementById('total-video-count').innerText = total;
            
            const slider = document.getElementById('rank-range');
            const display = document.getElementById('rank-value');
            const countDisplay = document.getElementById('video-count-display');

            function updateCount() {
                const percent = slider.value;
                display.innerText = `ä¸Šä½ ${percent}%`;
                const count = Math.ceil(total * (percent / 100));
                countDisplay.innerText = count;
            }

            slider.addEventListener('input', updateCount);
            updateCount(); // åˆå›å®Ÿè¡Œ
            switchScreen('start');
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹
        function startGame() {
            const percent = document.getElementById('rank-range').value;
            const count = Math.ceil(allVideos.length * (percent / 100));
            // ä¸Šä½ãƒ©ãƒ³ã‚¯é †ï¼ˆCSVãŒæ—¢ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹å‰æã€ã¾ãŸã¯Rankåˆ—ã§ã‚½ãƒ¼ãƒˆï¼‰
            // CSVã¯Ranké †ã¨ä»®å®šã™ã‚‹ãŒã€å¿µã®ç‚ºRankã§ã‚½ãƒ¼ãƒˆ
            allVideos.sort((a, b) => parseInt(a.Rank) - parseInt(b.Rank));
            filteredVideos = allVideos.slice(0, count);
            
            // æœ€å¤§å†ç”Ÿæ•°ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆå†ç”Ÿæ•°äºˆæƒ³ãƒ¢ãƒ¼ãƒ‰ç”¨ï¼‰
            maxViewCount = Math.max(...filteredVideos.map(v => parseInt(v.ViewCount)));

            const modeRadios = document.getElementsByName('mode');
            for(const radio of modeRadios) {
                if(radio.checked) currentMode = radio.value;
            }

            nextQuestion();
        }

        // æ¬¡ã®å•é¡Œã‚’å‡ºé¡Œ
        function nextQuestion() {
            if (filteredVideos.length === 0) return;

            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (blurTimer) {
                clearInterval(blurTimer);
                blurTimer = null;
            }
            blurSeconds = 0;

            // ãƒ©ãƒ³ãƒ€ãƒ ã«1ã¤é¸ã¶
            const randomIndex = Math.floor(Math.random() * filteredVideos.length);
            currentVideo = filteredVideos[randomIndex];

            // ç”»é¢ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
            document.getElementById('quiz-image').src = currentVideo.Thumbnail;
            document.getElementById('quiz-rank-info').innerText = `Rank: ${currentVideo.Rank}`;
            document.getElementById('quiz-view-count').innerText = parseInt(currentVideo.ViewCount).toLocaleString();
            
            // ãƒ¢ãƒ¼ãƒ‰åˆ¥è¡¨ç¤º
            const quizImage = document.getElementById('quiz-image');
            const quizTitleDisplay = document.getElementById('quiz-title-display');
            const normalOptions = document.getElementById('normal-options');
            const hardInput = document.getElementById('hard-input-area');
            const reverseOptions = document.getElementById('reverse-options');
            const highlowContainer = document.getElementById('highlow-container');
            const viewcountContainer = document.getElementById('viewcount-container');
            const zoomContainer = document.getElementById('zoom-container');
            const blurContainer = document.getElementById('blur-container');
            const titleInput = document.getElementById('title-input');

            // ã™ã¹ã¦ã‚’ä¸€æ—¦éè¡¨ç¤º
            quizImage.classList.remove('hidden');
            quizTitleDisplay.classList.add('hidden');
            normalOptions.classList.add('hidden');
            hardInput.classList.add('hidden');
            reverseOptions.classList.add('hidden');
            highlowContainer.classList.add('hidden');
            viewcountContainer.classList.add('hidden');
            zoomContainer.classList.add('hidden');
            blurContainer.classList.add('hidden');

            if (currentMode === 'normal') {
                normalOptions.classList.remove('hidden');
                generateNormalOptions();
            } else if (currentMode === 'reverse') {
                // é€†ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ï¼šã‚µãƒ ãƒã¯éš ã—ã¦ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¡¨ç¤º
                quizImage.classList.add('hidden');
                quizTitleDisplay.classList.remove('hidden');
                quizTitleDisplay.querySelector('p.font-bold').innerText = currentVideo.Title;
                reverseOptions.classList.remove('hidden');
                generateReverseOptions();
            } else if (currentMode === 'highlow') {
                // ãƒã‚¤ï¼†ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼šã‚µãƒ ãƒã¯éš ã™
                quizImage.classList.add('hidden');
                highlowContainer.classList.remove('hidden');
                generateHighLowQuestion();
            } else if (currentMode === 'viewcount') {
                // å†ç”Ÿæ•°äºˆæƒ³ãƒ¢ãƒ¼ãƒ‰
                quizImage.classList.remove('hidden');
                viewcountContainer.classList.remove('hidden');
                normalOptions.classList.add('hidden');
                setupViewCountMode();
            } else if (currentMode === 'zoom') {
                // ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰
                quizImage.classList.add('hidden');
                zoomContainer.classList.remove('hidden');
                normalOptions.classList.remove('hidden');
                setupZoomMode();
                generateNormalOptions();
            } else if (currentMode === 'blur') {
                // ã¼ã‹ã—ãƒ¢ãƒ¼ãƒ‰
                quizImage.classList.add('hidden');
                blurContainer.classList.remove('hidden');
                normalOptions.classList.remove('hidden');
                setupBlurMode();
                generateNormalOptions();
            } else {
                // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰
                hardInput.classList.remove('hidden');
                titleInput.value = ''; // ã‚¯ãƒªã‚¢
                // Enterã‚­ãƒ¼ã§å›ç­”ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                titleInput.onkeydown = (e) => { if(e.key === 'Enter') checkHardAnswer(); };
            }

            switchScreen('quiz');
        }

        // Levenshteinè·é›¢ã‚’è¨ˆç®—ï¼ˆæ–‡å­—åˆ—ã®é¡ä¼¼åº¦ï¼‰
        function levenshteinDistance(str1, str2) {
            // å…¥åŠ›æ¤œè¨¼
            if (str1 == null || str2 == null) return Infinity;
            str1 = String(str1);
            str2 = String(str2);
            
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šé¸æŠè‚¢ç”Ÿæˆï¼ˆæ”¹è‰¯ç‰ˆï¼‰
        function generateNormalOptions() {
            const container = document.getElementById('normal-options');
            container.innerHTML = '';

            // æ­£è§£ã‚¿ã‚¤ãƒˆãƒ«ã¨ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼šfilteredVideosã‚’ä½¿ç”¨ï¼ˆallVideosã‚ˆã‚Šå°‘ãªã„ï¼‰
            const videosToCheck = filteredVideos.length >= 4 ? filteredVideos : allVideos;
            const videosWithSimilarity = videosToCheck
                .filter(v => v.Title !== currentVideo.Title)
                .map(v => ({
                    video: v,
                    similarity: levenshteinDistance(currentVideo.Title, v.Title)
                }))
                .sort((a, b) => a.similarity - b.similarity); // é¡ä¼¼åº¦ãŒé«˜ã„é †ï¼ˆè·é›¢ãŒå°ã•ã„é †ï¼‰

            // ä¸Šä½ã‹ã‚‰3ã¤é¸ã¶ï¼ˆä¼¼ã¦ã„ã‚‹ã‚‚ã®ã‚’å„ªå…ˆï¼‰
            // ä¸‡ãŒä¸€3ã¤æœªæº€ã®å ´åˆã‚‚è€ƒæ…®
            const numDistractors = Math.min(3, videosWithSimilarity.length);
            const distractors = videosWithSimilarity.slice(0, numDistractors).map(item => item.video);

            // æ­£è§£ã¨æ··ãœã‚‹
            const options = [...distractors, currentVideo];
            shuffleArray(options);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-white border border-gray-300 hover:bg-red-50 hover:border-red-300 p-3 rounded-lg shadow-sm transition text-sm font-medium";
                btn.innerText = opt.Title;
                btn.onclick = () => checkNormalAnswer(opt);
                container.appendChild(btn);
            });
        }

        // é…åˆ—ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
        function checkNormalAnswer(selected) {
            selectedVideo = selected;
            const isCorrect = selected.Title === currentVideo.Title;
            showResult(isCorrect);
        }

        // ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
        function checkHardAnswer() {
            const input = document.getElementById('title-input').value;
            // æ­£è¦åŒ–ï¼ˆå‰å¾Œã®ç©ºç™½å‰Šé™¤ã€å°æ–‡å­—åŒ–ï¼‰ã—ã¦æ¯”è¼ƒ
            const normalize = (str) => str.trim().toLowerCase().replace(/\s+/g, '');
            
            // å®Œå…¨ä¸€è‡´ãŒåŸå‰‡ã ãŒã€ä½¿ã„å‹æ‰‹ã®ãŸã‚æ­£è¦åŒ–ã—ã¦æ¯”è¼ƒ
            const isCorrect = normalize(input) === normalize(currentVideo.Title);
            showResult(isCorrect);
        }

        // é€†ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ï¼šé¸æŠè‚¢ç”Ÿæˆ
        function generateReverseOptions() {
            const container = document.getElementById('reverse-options');
            container.innerHTML = '';

            // æ­£è§£ã‚¿ã‚¤ãƒˆãƒ«ã¨ã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ã—ã¦ã€é¡ä¼¼ã—ãŸã‚¿ã‚¤ãƒˆãƒ«ã®å‹•ç”»ã‚’é¸ã¶
            const videosToCheck = filteredVideos.length >= 4 ? filteredVideos : allVideos;
            const videosWithSimilarity = videosToCheck
                .filter(v => v.Title !== currentVideo.Title)
                .map(v => ({
                    video: v,
                    similarity: levenshteinDistance(currentVideo.Title, v.Title)
                }))
                .sort((a, b) => a.similarity - b.similarity); // é¡ä¼¼åº¦ãŒé«˜ã„é †ï¼ˆè·é›¢ãŒå°ã•ã„é †ï¼‰

            // é¡ä¼¼åº¦ãŒé«˜ã„ä¸Šä½3ã¤ã‚’é¸æŠè‚¢ã¨ã—ã¦ä½¿ç”¨
            const numDistractors = Math.min(3, videosWithSimilarity.length);
            const distractors = videosWithSimilarity.slice(0, numDistractors).map(item => item.video);

            // æ­£è§£ã¨æ··ãœã‚‹
            const options = [...distractors, currentVideo];
            shuffleArray(options);

            // ã‚µãƒ ãƒã‚’ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = "cursor-pointer border-2 border-gray-300 hover:border-purple-500 rounded-lg overflow-hidden transition";
                div.innerHTML = `<img src="${opt.Thumbnail}" alt="ã‚µãƒ ãƒã‚¤ãƒ«" class="w-full h-auto">`;
                div.onclick = () => checkReverseAnswer(opt);
                container.appendChild(div);
            });
        }

        // é€†ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
        function checkReverseAnswer(selected) {
            selectedVideo = selected;
            const isCorrect = selected.Title === currentVideo.Title;
            showResult(isCorrect);
        }

        // ãƒã‚¤ï¼†ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼šå•é¡Œç”Ÿæˆ
        function generateHighLowQuestion() {
            // å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼šååˆ†ãªå‹•ç”»ãŒã‚ã‚‹ã‹ç¢ºèª
            if (filteredVideos.length < 2) {
                console.error('Not enough videos for High&Low mode');
                return;
            }
            
            // 2ã¤ç›®ã®å‹•ç”»ã‚’ãƒ©ãƒ³ãƒ€ãƒ ã«é¸ã¶
            let attempts = 0;
            const maxAttempts = 100;
            do {
                const randomIndex = Math.floor(Math.random() * filteredVideos.length);
                currentVideo2 = filteredVideos[randomIndex];
                attempts++;
            } while(currentVideo2.Title === currentVideo.Title && attempts < maxAttempts);

            // UIè¡¨ç¤º
            document.getElementById('highlow-video1-thumb').src = currentVideo.Thumbnail;
            document.getElementById('highlow-video1-title').innerText = currentVideo.Title;
            
            document.getElementById('highlow-video2-thumb').src = currentVideo2.Thumbnail;
            document.getElementById('highlow-video2-title').innerText = currentVideo2.Title;
        }

        // ãƒã‚¤ï¼†ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
        function checkHighLowAnswer(videoNumber) {
            const selected = (videoNumber === 1) ? currentVideo : currentVideo2;
            selectedVideo = selected;
            const otherVideo = (videoNumber === 1) ? currentVideo2 : currentVideo;
            const isCorrect = parseInt(selected.ViewCount) > parseInt(otherVideo.ViewCount);
            
            // çµæœè¡¨ç¤ºæ™‚ã«ä¸¡æ–¹ã®å†ç”Ÿæ•°ã‚’è¡¨ç¤º
            showHighLowResult(isCorrect, currentVideo, currentVideo2);
        }

        // ãƒã‚¤ï¼†ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰çµæœè¡¨ç¤º
        function showHighLowResult(isCorrect, video1, video2) {
            const msgEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const detailEl = document.getElementById('result-detail');
            const linkEl = document.getElementById('result-link');
            const resultThumbnail = document.getElementById('result-thumbnail');
            
            // èª¤ç­”ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const wrongSection = document.getElementById('wrong-answer-section');
            const wrongTitleEl = document.getElementById('wrong-answer-title');
            const wrongLinkEl = document.getElementById('wrong-answer-link');
            const wrongThumbnail = document.getElementById('wrong-answer-thumbnail');

            if (isCorrect) {
                msgEl.innerText = "â­• æ­£è§£ï¼";
                msgEl.className = "text-3xl font-bold mb-4 text-green-600";
                wrongSection.classList.add('hidden');
            } else {
                msgEl.innerText = "âŒ æ®‹å¿µ...";
                msgEl.className = "text-3xl font-bold mb-4 text-red-600";
                
                // é¸æŠã—ãŸæ–¹ã‚’èª¤ç­”ã¨ã—ã¦è¡¨ç¤º
                if (selectedVideo) {
                    wrongSection.classList.remove('hidden');
                    wrongTitleEl.innerText = selectedVideo.Title;
                    wrongLinkEl.href = selectedVideo.URL;
                    wrongThumbnail.src = selectedVideo.Thumbnail;
                } else {
                    wrongSection.classList.add('hidden');
                }
            }

            titleEl.innerText = "å†ç”Ÿæ•°æ¯”è¼ƒ";
            detailEl.innerHTML = `
                <p class="mb-1"><strong>${video1.Title}</strong></p>
                <p class="text-blue-600 font-bold mb-3">${parseInt(video1.ViewCount).toLocaleString()} å›</p>
                <p class="mb-1"><strong>${video2.Title}</strong></p>
                <p class="text-blue-600 font-bold">${parseInt(video2.ViewCount).toLocaleString()} å›</p>
            `;
            
            // ãƒªãƒ³ã‚¯ã¯å†ç”Ÿæ•°ãŒå¤šã„æ–¹ã‚’è¡¨ç¤ºï¼ˆæ­£è§£ï¼‰
            const winnerVideo = parseInt(video1.ViewCount) > parseInt(video2.ViewCount) ? video1 : video2;
            linkEl.href = winnerVideo.URL;
            resultThumbnail.src = winnerVideo.Thumbnail;

            switchScreen('result');
        }

        // çµæœè¡¨ç¤º
        function showResult(isCorrect) {
            const msgEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const detailEl = document.getElementById('result-detail');
            const linkEl = document.getElementById('result-link');
            const resultThumbnail = document.getElementById('result-thumbnail');
            
            // èª¤ç­”ã‚»ã‚¯ã‚·ãƒ§ãƒ³
            const wrongSection = document.getElementById('wrong-answer-section');
            const wrongTitleEl = document.getElementById('wrong-answer-title');
            const wrongLinkEl = document.getElementById('wrong-answer-link');
            const wrongThumbnail = document.getElementById('wrong-answer-thumbnail');

            if (isCorrect) {
                msgEl.innerText = "â­• æ­£è§£ï¼";
                msgEl.className = "text-3xl font-bold mb-4 text-green-600";
                wrongSection.classList.add('hidden');
            } else {
                msgEl.innerText = "âŒ æ®‹å¿µ...";
                msgEl.className = "text-3xl font-bold mb-4 text-red-600";
                
                // èª¤ç­”ã‚’è¡¨ç¤ºï¼ˆãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ï¼‰
                if (selectedVideo && selectedVideo !== currentVideo) {
                    wrongSection.classList.remove('hidden');
                    wrongTitleEl.innerText = selectedVideo.Title;
                    wrongLinkEl.href = selectedVideo.URL;
                    wrongThumbnail.src = selectedVideo.Thumbnail;
                } else {
                    wrongSection.classList.add('hidden');
                }
            }

            titleEl.innerText = currentVideo.Title;
            detailEl.innerHTML = ''; // ã‚¯ãƒªã‚¢ï¼ˆãƒã‚¤ï¼†ãƒ­ãƒ¼ãƒ¢ãƒ¼ãƒ‰ä»¥å¤–ã§ã¯ç©ºï¼‰
            linkEl.href = currentVideo.URL;
            resultThumbnail.src = currentVideo.Thumbnail;

            switchScreen('result');
        }

        function backToMenu() {
            // ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
            if (blurTimer) {
                clearInterval(blurTimer);
                blurTimer = null;
            }
            switchScreen('start');
        }

        // å†ç”Ÿæ•°äºˆæƒ³ãƒ¢ãƒ¼ãƒ‰ï¼šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupViewCountMode() {
            const slider = document.getElementById('viewcount-slider');
            const display = document.getElementById('viewcount-display');
            
            // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æœ€å¤§å€¤ã‚’é©åˆ‡ã«è¨­å®šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¸ˆã¿ã®æœ€å¤§å†ç”Ÿæ•°ã‹ã‚‰è¨ˆç®—ï¼‰
            slider.max = Math.ceil(maxViewCount * SLIDER_MAX_MULTIPLIER);
            slider.value = Math.floor(maxViewCount / SLIDER_INITIAL_DIVISOR);
            
            // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
            slider.removeEventListener('input', updateViewCountDisplay);
            slider.addEventListener('input', updateViewCountDisplay);
            updateViewCountDisplay();
        }

        // å†ç”Ÿæ•°äºˆæƒ³ãƒ¢ãƒ¼ãƒ‰ï¼šå›ç­”ãƒã‚§ãƒƒã‚¯
        function checkViewCountAnswer() {
            const guessedCount = parseInt(document.getElementById('viewcount-slider').value);
            const actualCount = parseInt(currentVideo.ViewCount);
            
            const isCorrect = Math.abs(guessedCount - actualCount) <= VIEWCOUNT_MARGIN;
            
            // çµæœè¡¨ç¤ºæ™‚ã«äºˆæƒ³å€¤ã¨å®Ÿéš›ã®å€¤ã‚’è¡¨ç¤º
            const msgEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const detailEl = document.getElementById('result-detail');
            const linkEl = document.getElementById('result-link');
            const resultThumbnail = document.getElementById('result-thumbnail');
            const wrongSection = document.getElementById('wrong-answer-section');
            
            if (isCorrect) {
                msgEl.innerText = "â­• æ­£è§£ï¼";
                msgEl.className = "text-3xl font-bold mb-4 text-green-600";
                wrongSection.classList.add('hidden');
            } else {
                msgEl.innerText = "âŒ æ®‹å¿µ...";
                msgEl.className = "text-3xl font-bold mb-4 text-red-600";
                wrongSection.classList.add('hidden');
            }
            
            titleEl.innerText = currentVideo.Title;
            detailEl.innerHTML = `
                <p class="mb-1">ã‚ãªãŸã®äºˆæƒ³: <strong class="text-yellow-600">${guessedCount.toLocaleString()}</strong> å›</p>
                <p class="mb-1">å®Ÿéš›ã®å†ç”Ÿæ•°: <strong class="text-blue-600">${actualCount.toLocaleString()}</strong> å›</p>
                <p class="text-sm text-gray-600">èª¤å·®: ${Math.abs(guessedCount - actualCount).toLocaleString()} å›</p>
            `;
            linkEl.href = currentVideo.URL;
            resultThumbnail.src = currentVideo.Thumbnail;
            
            switchScreen('result');
        }

        // ã‚ºãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ï¼šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupZoomMode() {
            const zoomImage = document.getElementById('zoom-image');
            const viewport = document.getElementById('zoom-viewport');
            
            zoomImage.src = currentVideo.Thumbnail;
            
            // ã‚µãƒ ãƒã‚¤ãƒ«ã‚’å®šæ•°ã§å®šç¾©ã•ã‚ŒãŸå€ç‡ã§æ‹¡å¤§ã—ã¦ã€ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‚’è¡¨ç¤º
            zoomImage.style.width = (THUMBNAIL_WIDTH * ZOOM_SCALE) + 'px';
            zoomImage.style.height = (THUMBNAIL_HEIGHT * ZOOM_SCALE) + 'px';
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã‚’é¸æŠï¼ˆç”»åƒãŒã¯ã¿å‡ºã™ç¯„å›²ã§ï¼‰
            // è² ã®å€¤ã®ç¯„å›²å†…ã§ãƒ©ãƒ³ãƒ€ãƒ ã«é…ç½®ã™ã‚‹ãŸã‚ã€çµ¶å¯¾å€¤ã‚’ä½¿ã£ã¦ãƒ©ãƒ³ãƒ€ãƒ å€¤ã‚’ç”Ÿæˆå¾Œã«è² ã«ã™ã‚‹
            const maxOffsetLeft = THUMBNAIL_WIDTH * (ZOOM_SCALE - 1);
            const maxOffsetTop = THUMBNAIL_HEIGHT * (ZOOM_SCALE - 1);
            const randomLeft = -Math.floor(Math.random() * maxOffsetLeft);
            const randomTop = -Math.floor(Math.random() * maxOffsetTop);
            
            zoomImage.style.left = randomLeft + 'px';
            zoomImage.style.top = randomTop + 'px';
        }

        // ã¼ã‹ã—ãƒ¢ãƒ¼ãƒ‰ï¼šã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        function setupBlurMode() {
            const blurImage = document.getElementById('blur-image');
            const timerDisplay = document.getElementById('blur-timer');
            
            blurImage.src = currentVideo.Thumbnail;
            blurImage.style.filter = `blur(${BLUR_INITIAL}px)`;
            blurSeconds = 0;
            timerDisplay.innerText = blurSeconds;
            
            // 1ç§’ã”ã¨ã«ã¼ã‹ã—ã‚’æ¸›ã‚‰ã™
            blurTimer = setInterval(() => {
                blurSeconds++;
                timerDisplay.innerText = blurSeconds;
                
                // å®šæ•°ã§å®šç¾©ã•ã‚ŒãŸæœŸé–“ã§å®Œå…¨ã«é®®æ˜ã«ã™ã‚‹
                const blurAmount = Math.max(0, BLUR_INITIAL - (blurSeconds * BLUR_STEP));
                blurImage.style.filter = `blur(${blurAmount}px)`;
                
                if (blurSeconds >= BLUR_DURATION) {
                    clearInterval(blurTimer);
                    blurTimer = null;
                }
            }, 1000);
        }

        // ==========================================
        // è¨­å®šãƒ»ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½
        // ==========================================

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.remove('hidden');
            updateDataSourceSelect();
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeSettingsModal() {
            document.getElementById('settings-modal').classList.add('hidden');
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹é¸æŠã®æ›´æ–°
        function updateDataSourceSelect() {
            const select = document.getElementById('data-source-select');
            // ã™ã¹ã¦ã‚¯ãƒªã‚¢
            select.innerHTML = '';
            
            // datasãƒ•ã‚©ãƒ«ãƒ€ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
            availableCSVFiles.forEach(csv => {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: å¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ç¢ºèª
                if (!csv.filename || !csv.displayName) return;
                
                const option = document.createElement('option');
                option.value = csv.filename;
                // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: textContentã‚’ä½¿ç”¨ã—ã¦XSSå¯¾ç­–
                option.textContent = csv.displayName;
                select.appendChild(option);
            });
            
            // ç”Ÿæˆã—ãŸCSVã‚’è¿½åŠ 
            generatedCSVs.forEach(csv => {
                if (!csv.name) return;
                
                const option = document.createElement('option');
                option.value = csv.name;
                option.textContent = csv.name;
                select.appendChild(option);
            });
            
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’é¸æŠ
            select.value = currentDataSource;
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å¤‰æ›´æ™‚
        function onDataSourceChange() {
            const select = document.getElementById('data-source-select');
            const newSource = select.value;
            
            // datasãƒ•ã‚©ãƒ«ãƒ€ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆ
            const isDatasFolderCSV = availableCSVFiles.some(csv => csv.filename === newSource);
            if (isDatasFolderCSV) {
                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: ãƒ•ã‚¡ã‚¤ãƒ«åãŒå®‰å…¨ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                if (isValidFilename(newSource)) {
                    CSV_FILE = 'datas/' + newSource;
                    loadCSVData();
                } else {
                    console.error('ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«å:', newSource);
                }
            } else {
                // ç”Ÿæˆã—ãŸCSVã‹ã‚‰èª­ã¿è¾¼ã¿
                const csvData = generatedCSVs.find(csv => csv.name === newSource);
                if (csvData) {
                    allVideos = csvData.data;
                    currentDataSource = newSource;
                    initMenu();
                }
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«åã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«å¯¾ç­–ï¼‰
        function isValidFilename(filename) {
            if (typeof filename !== 'string') return false;
            // ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã‚’é˜²ã
            if (filename.includes('..') || filename.includes('/') || filename.includes('\\')) return false;
            // .csvæ‹¡å¼µå­ã®ã¿è¨±å¯
            if (!filename.endsWith('.csv')) return false;
            return true;
        }

        // manifestãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
        function loadManifest() {
            fetch('datas/manifest.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('manifest.jsonãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    return response.json();
                })
                .then(data => {
                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: dataãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                    if (!Array.isArray(data)) {
                        throw new Error('manifest.jsonã¯é…åˆ—ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™');
                    }
                    
                    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: å„è¦ç´ ãŒå¿…é ˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æŒã¤ã“ã¨ã‚’ç¢ºèª
                    const validFiles = data.filter(item => {
                        return item && 
                               typeof item === 'object' &&
                               typeof item.filename === 'string' &&
                               typeof item.displayName === 'string' &&
                               isValidFilename(item.filename);
                    });
                    
                    if (validFiles.length === 0) {
                        throw new Error('æœ‰åŠ¹ãªCSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                    
                    availableCSVFiles = validFiles;
                    // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã—ã¦è¨­å®š
                    CSV_FILE = 'datas/' + availableCSVFiles[0].filename;
                    currentDataSource = availableCSVFiles[0].filename;
                    loadCSVData();
                })
                .catch(error => {
                    console.error('Manifestèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
                    availableCSVFiles = [
                        { filename: 'nobamangames.csv', displayName: 'nobamangames' }
                    ];
                    CSV_FILE = 'datas/nobamangames.csv';
                    currentDataSource = 'nobamangames.csv';
                    loadCSVData();
                });
        }

        // CSVãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆå…±é€šé–¢æ•°ï¼‰
        function loadCSVData() {
            screens.loading.classList.remove('hidden');
            screens.start.classList.add('hidden');
            
            Papa.parse(CSV_FILE, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allVideos = results.data;
                        currentDataSource = CSV_FILE.split('/').pop();
                        initMenu();
                    } else {
                        showError("ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚");
                    }
                },
                error: function(err) {
                    showError("CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" + err);
                }
            });
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
        function importCSVFile() {
            const fileInput = document.getElementById('csv-file-input');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        const fileName = file.name;
                        
                        // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ãªã„ã‚ˆã†ãƒã‚§ãƒƒã‚¯
                        const existingIndex = generatedCSVs.findIndex(csv => csv.name === fileName);
                        if (existingIndex >= 0) {
                            generatedCSVs[existingIndex].data = results.data;
                        } else {
                            generatedCSVs.push({
                                name: fileName,
                                data: results.data
                            });
                        }
                        
                        allVideos = results.data;
                        currentDataSource = fileName;
                        updateDataSourceSelect();
                        initMenu();
                        alert(`${fileName} ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
                    } else {
                        alert("CSVãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™ã€‚");
                    }
                },
                error: function(err) {
                    alert("CSVã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
                }
            });
        }

        // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’CSVã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportCurrentCSV() {
            if (allVideos.length === 0) {
                alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
                return;
            }
            
            const csv = Papa.unparse(allVideos);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', currentDataSource || 'exported_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==========================================
        // YouTube Data API ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½
        // ==========================================

        async function fetchYouTubeData() {
            const apiKey = document.getElementById('api-key-input').value.trim();
            const channelId = document.getElementById('channel-id-input').value.trim();
            const excludeShorts = document.getElementById('exclude-shorts-checkbox').checked;
            const statusEl = document.getElementById('fetch-status');
            
            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (!apiKey || !channelId) {
                alert('API Keyã¨Channel IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-red-600 inline-block mr-2"></div>ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';
            
            try {
                // 1. ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±å–å¾—
                statusEl.innerHTML = '1/4: ãƒãƒ£ãƒ³ãƒãƒ«æƒ…å ±ã‚’å–å¾—ä¸­...';
                const channelUrl = `https://www.googleapis.com/youtube/v3/channels?part=contentDetails&id=${channelId}&key=${apiKey}`;
                const channelResponse = await fetch(channelUrl);
                const channelData = await channelResponse.json();
                
                if (!channelData.items || channelData.items.length === 0) {
                    throw new Error('ãƒãƒ£ãƒ³ãƒãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚IDã¾ãŸã¯APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
                
                const uploadsPlaylistId = channelData.items[0].contentDetails.relatedPlaylists.uploads;
                
                // 2. å…¨å‹•ç”»IDå–å¾—
                statusEl.innerHTML = '2/4: å‹•ç”»IDãƒªã‚¹ãƒˆã‚’å–å¾—ä¸­...';
                const videoIds = [];
                let nextPageToken = null;
                
                do {
                    const playlistUrl = `https://www.googleapis.com/youtube/v3/playlistItems?part=contentDetails&playlistId=${uploadsPlaylistId}&maxResults=50&pageToken=${nextPageToken || ''}&key=${apiKey}`;
                    const playlistResponse = await fetch(playlistUrl);
                    const playlistData = await playlistResponse.json();
                    
                    if (playlistData.items) {
                        playlistData.items.forEach(item => {
                            videoIds.push(item.contentDetails.videoId);
                        });
                    }
                    
                    nextPageToken = playlistData.nextPageToken;
                } while (nextPageToken);
                
                statusEl.innerHTML = `2/4: ${videoIds.length}æœ¬ã®å‹•ç”»IDã‚’å–å¾—ã—ã¾ã—ãŸ...`;
                
                // 3. å‹•ç”»è©³ç´°å–å¾—
                statusEl.innerHTML = '3/4: å‹•ç”»è©³ç´°ã‚’å–å¾—ä¸­...';
                const videosData = [];
                const chunkSize = 50;
                
                for (let i = 0; i < videoIds.length; i += chunkSize) {
                    const chunkIds = videoIds.slice(i, i + chunkSize);
                    const idsString = chunkIds.join(',');
                    
                    const videoUrl = `https://www.googleapis.com/youtube/v3/videos?part=snippet,statistics,contentDetails&id=${idsString}&key=${apiKey}`;
                    const videoResponse = await fetch(videoUrl);
                    const videoData = await videoResponse.json();
                    
                    if (videoData.items) {
                        for (const item of videoData.items) {
                            const videoId = item.id;
                            const snippet = item.snippet;
                            const stats = item.statistics;
                            const contentDetails = item.contentDetails;
                            
                            // ISO 8601å½¢å¼ã®æ™‚é–“ã‚’ãƒ‘ãƒ¼ã‚¹
                            const duration = parseISO8601Duration(contentDetails.duration);
                            
                            // Shortsåˆ¤å®š
                            if (excludeShorts && duration <= 60) {
                                const title = snippet.title.toLowerCase();
                                const description = (snippet.description || '').toLowerCase();
                                if (title.includes('#shorts') || description.includes('#shorts')) {
                                    continue; // Shortsã‚’é™¤å¤–
                                }
                            }
                            
                            videosData.push({
                                Title: snippet.title,
                                ViewCount: parseInt(stats.viewCount || 0),
                                URL: `https://www.youtube.com/watch?v=${videoId}`,
                                Thumbnail: snippet.thumbnails.high?.url || snippet.thumbnails.default?.url || '',
                                PublishedAt: snippet.publishedAt,
                                DurationSec: duration
                            });
                        }
                    }
                    
                    statusEl.innerHTML = `3/4: ${Math.min(i + chunkSize, videoIds.length)}/${videoIds.length} å‡¦ç†å®Œäº† (ä¿å­˜å¯¾è±¡: ${videosData.length}æœ¬)`;
                }
                
                // 4. ã‚½ãƒ¼ãƒˆã¨ãƒ©ãƒ³ã‚¯ä»˜ã‘
                statusEl.innerHTML = '4/4: ãƒ‡ãƒ¼ã‚¿ã‚’ã‚½ãƒ¼ãƒˆä¸­...';
                videosData.sort((a, b) => b.ViewCount - a.ViewCount);
                videosData.forEach((video, index) => {
                    video.Rank = index + 1;
                });
                
                // ç”Ÿæˆã—ãŸCSVã‚’ä¿å­˜
                // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ç”Ÿæˆ: ISOå½¢å¼ã‹ã‚‰ä¸è¦ãªè¨˜å·ã‚’å‰Šé™¤ã—ã€ãƒŸãƒªç§’ã¨Zã‚’é™¤å» (ä¾‹: 2026-01-13T15-23-45)
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const fileName = `youtube_${channelId}_${timestamp}.csv`;
                
                generatedCSVs.push({
                    name: fileName,
                    data: videosData
                });
                
                allVideos = videosData;
                currentDataSource = fileName;
                
                statusEl.innerHTML = `âœ… å®Œäº†ï¼${videosData.length}æœ¬ã®å‹•ç”»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚`;
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                    updateDataSourceSelect();
                    initMenu();
                    alert(`ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼\n${videosData.length}æœ¬ã®å‹•ç”»ã‚’å–å¾—ã—ã¾ã—ãŸã€‚\n\nãƒ•ã‚¡ã‚¤ãƒ«å: ${fileName}`);
                }, 2000);
                
            } catch (error) {
                statusEl.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                console.error('YouTube API Error:', error);
                setTimeout(() => statusEl.classList.add('hidden'), 5000);
            }
        }

        // ISO 8601å½¢å¼ã®æ™‚é–“ã‚’ç§’ã«å¤‰æ›
        function parseISO8601Duration(duration) {
            // Support decimal seconds (e.g., PT1M30.5S)
            const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+(?:\.\d+)?)S)?/);
            if (!match) return 0;
            
            const hours = parseInt(match[1] || 0);
            const minutes = parseInt(match[2] || 0);
            const seconds = parseFloat(match[3] || 0);
            
            return hours * 3600 + minutes * 60 + seconds;
        }
    
    </script>
</body>
</html>