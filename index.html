<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTuberサムネイルクイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg overflow-hidden p-6">
        
        <header class="mb-6 text-center border-b pb-4">
            <h1 class="text-2xl font-bold text-red-600">YouTube サムネイルクイズ</h1>
            <p class="text-sm text-gray-500 mt-1">サムネを見て動画タイトルを当てよう！</p>
        </header>

        <div id="loading-screen" class="text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
            <p>ランキングデータを読み込み中...</p>
        </div>

        <div id="error-screen" class="hidden text-center py-10 text-red-600">
            <p id="error-message">データの読み込みに失敗しました。</p>
            <p class="text-sm mt-2 text-gray-500">csvファイルが同じフォルダにあるか確認してください。</p>
        </div>

        <div id="start-screen" class="hidden fade-in space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h2 class="font-bold mb-2">① 出題範囲（ランキング）</h2>
                <input type="range" id="rank-range" min="10" max="100" value="50" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-sm mt-1">
                    <span>上位10% (有名)</span>
                    <span id="rank-value" class="font-bold text-blue-600">上位 50%</span>
                    <span>100% (マニア)</span>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    対象動画数: <span id="video-count-display">0</span> 本 / 全 <span id="total-video-count">0</span> 本
                </p>
            </div>

            <div class="bg-green-50 p-4 rounded-lg">
                <h2 class="font-bold mb-2">② モード選択</h2>
                <div class="grid grid-cols-2 gap-2">
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" name="mode" value="normal" checked class="form-radio text-green-600">
                        <span>通常モード (4択)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" name="mode" value="hard" class="form-radio text-red-600">
                        <span>ハードモード (入力)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" id="mode-reverse" name="mode" value="reverse" class="form-radio text-purple-600">
                        <span>逆クイズ (タイトル→サムネ)</span>
                    </label>
                    <label class="cursor-pointer flex items-center gap-2">
                        <input type="radio" id="mode-highlow" name="mode" value="highlow" class="form-radio text-blue-600">
                        <span>ハイ＆ロー (再生数当て)</span>
                    </label>
                </div>
            </div>

            <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition transform hover:scale-105">
                ゲームスタート
            </button>
        </div>

        <div id="quiz-screen" class="hidden fade-in">
            <div class="mb-4 flex justify-between items-center text-sm text-gray-500">
                <span id="quiz-rank-info">Rank: ???</span>
                <span class="bg-gray-200 px-2 py-1 rounded">View: <span id="quiz-view-count">0</span></span>
            </div>

            <div class="flex justify-center mb-6">
                <img id="quiz-image" src="" alt="Thumbnail" class="rounded-lg shadow-md max-h-64 object-cover border-2 border-gray-200">
            </div>

            <!-- 逆クイズ用：タイトル表示エリア -->
            <div id="quiz-title-display" class="hidden text-center mb-6 p-4 bg-purple-50 rounded-lg border-2 border-purple-300">
                <p class="text-xs text-gray-500 mb-2">このタイトルの動画はどれ？</p>
                <p class="font-bold text-lg"></p>
            </div>

            <div id="normal-options" class="grid grid-cols-1 gap-3">
                </div>

            <div id="hard-input-area" class="hidden flex flex-col gap-3">
                <input type="text" id="title-input" placeholder="動画タイトルを入力..." class="border-2 border-gray-300 p-3 rounded-lg w-full focus:outline-none focus:border-red-500">
                <button onclick="checkHardAnswer()" class="bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700">回答する</button>
                <p class="text-xs text-gray-400 text-center">※スペースや大文字小文字は無視されます</p>
            </div>

            <!-- 逆クイズ用：サムネイル選択エリア -->
            <div id="reverse-options" class="hidden grid grid-cols-2 gap-4">
            </div>

            <!-- ハイ＆ロー用：2つの動画比較エリア -->
            <div id="highlow-container" class="hidden space-y-4">
                <div class="text-center font-bold text-lg mb-4">どちらの再生数が多い？</div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="cursor-pointer border-2 border-gray-300 hover:border-blue-500 rounded-lg p-4 transition" onclick="checkHighLowAnswer(1)">
                        <img id="highlow-video1-thumb" src="" alt="サムネ1" class="w-full rounded mb-2">
                        <p id="highlow-video1-title" class="text-sm font-medium text-center"></p>
                    </div>
                    <div class="cursor-pointer border-2 border-gray-300 hover:border-blue-500 rounded-lg p-4 transition" onclick="checkHighLowAnswer(2)">
                        <img id="highlow-video2-thumb" src="" alt="サムネ2" class="w-full rounded mb-2">
                        <p id="highlow-video2-title" class="text-sm font-medium text-center"></p>
                    </div>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden fade-in text-center">
            <h2 id="result-message" class="text-3xl font-bold mb-4"></h2>
            
            <!-- 誤答の場合：選択した動画を表示 -->
            <div id="wrong-answer-section" class="hidden bg-red-50 p-4 rounded-lg mb-4 text-left border-2 border-red-200">
                <p class="text-xs text-gray-500 mb-1">あなたの回答</p>
                <p id="wrong-answer-title" class="font-bold text-lg mb-2 text-gray-900"></p>
                <a id="wrong-answer-link" href="#" target="_blank" class="text-blue-600 underline text-sm hover:text-blue-800 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                    YouTubeで見る
                </a>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                <p class="text-xs text-gray-500 mb-1">正解の動画</p>
                <p id="result-title" class="font-bold text-lg mb-2 text-gray-900"></p>
                <div id="result-detail" class="mb-2"></div>
                <a id="result-link" href="#" target="_blank" class="text-blue-600 underline text-sm hover:text-blue-800 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                    YouTubeで見る
                </a>
            </div>

            <div class="flex gap-4">
                <button onclick="backToMenu()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">
                    メニューに戻る
                </button>
                <button onclick="nextQuestion()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">
                    次の問題
                </button>
            </div>
        </div>

    </div>

    <script>
        // 設定
        const CSV_FILE = 'all_videos_ranking.csv';
        
        // 状態変数
        let allVideos = [];
        let filteredVideos = [];
        let currentVideo = null;
        let currentVideo2 = null; // ハイ＆ローモード用
        let selectedVideo = null; // 選択された動画（誤答時に表示用）
        let currentMode = 'normal';

        // DOM要素
        const screens = {
            loading: document.getElementById('loading-screen'),
            error: document.getElementById('error-screen'),
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };

        // 初期化：CSV読み込み
        window.onload = function() {
            Papa.parse(CSV_FILE, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allVideos = results.data;
                        initMenu();
                    } else {
                        showError("データが空です。");
                    }
                },
                error: function(err) {
                    showError("CSVの読み込みに失敗しました。" + err);
                }
            });
        };

        function showError(msg) {
            screens.loading.classList.add('hidden');
            screens.error.classList.remove('hidden');
            document.getElementById('error-message').innerText = msg;
        }

        function switchScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        // メニューの初期化
        function initMenu() {
            const total = allVideos.length;
            document.getElementById('total-video-count').innerText = total;
            
            const slider = document.getElementById('rank-range');
            const display = document.getElementById('rank-value');
            const countDisplay = document.getElementById('video-count-display');

            function updateCount() {
                const percent = slider.value;
                display.innerText = `上位 ${percent}%`;
                const count = Math.ceil(total * (percent / 100));
                countDisplay.innerText = count;
            }

            slider.addEventListener('input', updateCount);
            updateCount(); // 初回実行
            switchScreen('start');
        }

        // ゲーム開始
        function startGame() {
            const percent = document.getElementById('rank-range').value;
            const count = Math.ceil(allVideos.length * (percent / 100));
            // 上位ランク順（CSVが既にソートされている前提、またはRank列でソート）
            // CSVはRank順と仮定するが、念の為Rankでソート
            allVideos.sort((a, b) => parseInt(a.Rank) - parseInt(b.Rank));
            filteredVideos = allVideos.slice(0, count);

            const modeRadios = document.getElementsByName('mode');
            for(const radio of modeRadios) {
                if(radio.checked) currentMode = radio.value;
            }

            nextQuestion();
        }

        // 次の問題を出題
        function nextQuestion() {
            if (filteredVideos.length === 0) return;

            // ランダムに1つ選ぶ
            const randomIndex = Math.floor(Math.random() * filteredVideos.length);
            currentVideo = filteredVideos[randomIndex];

            // 画面セットアップ
            document.getElementById('quiz-image').src = currentVideo.Thumbnail;
            document.getElementById('quiz-rank-info').innerText = `Rank: ${currentVideo.Rank}`;
            document.getElementById('quiz-view-count').innerText = parseInt(currentVideo.ViewCount).toLocaleString();
            
            // モード別表示
            const quizImage = document.getElementById('quiz-image');
            const quizTitleDisplay = document.getElementById('quiz-title-display');
            const normalOptions = document.getElementById('normal-options');
            const hardInput = document.getElementById('hard-input-area');
            const reverseOptions = document.getElementById('reverse-options');
            const highlowContainer = document.getElementById('highlow-container');
            const titleInput = document.getElementById('title-input');

            // すべてを一旦非表示
            quizImage.classList.remove('hidden');
            quizTitleDisplay.classList.add('hidden');
            normalOptions.classList.add('hidden');
            hardInput.classList.add('hidden');
            reverseOptions.classList.add('hidden');
            highlowContainer.classList.add('hidden');

            if (currentMode === 'normal') {
                normalOptions.classList.remove('hidden');
                generateNormalOptions();
            } else if (currentMode === 'reverse') {
                // 逆クイズモード：サムネは隠してタイトルを表示
                quizImage.classList.add('hidden');
                quizTitleDisplay.classList.remove('hidden');
                quizTitleDisplay.querySelector('p.font-bold').innerText = currentVideo.Title;
                reverseOptions.classList.remove('hidden');
                generateReverseOptions();
            } else if (currentMode === 'highlow') {
                // ハイ＆ローモード：サムネは隠す
                quizImage.classList.add('hidden');
                highlowContainer.classList.remove('hidden');
                generateHighLowQuestion();
            } else {
                // ハードモード
                hardInput.classList.remove('hidden');
                titleInput.value = ''; // クリア
                // Enterキーで回答できるようにする
                titleInput.onkeydown = (e) => { if(e.key === 'Enter') checkHardAnswer(); };
            }

            switchScreen('quiz');
        }

        // Levenshtein距離を計算（文字列の類似度）
        function levenshteinDistance(str1, str2) {
            // 入力検証
            if (str1 == null || str2 == null) return Infinity;
            str1 = String(str1);
            str2 = String(str2);
            
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // 通常モード：選択肢生成（改良版）
        function generateNormalOptions() {
            const container = document.getElementById('normal-options');
            container.innerHTML = '';

            // 正解タイトルとの類似度を計算
            // パフォーマンス最適化：filteredVideosを使用（allVideosより少ない）
            const videosToCheck = filteredVideos.length >= 4 ? filteredVideos : allVideos;
            const videosWithSimilarity = videosToCheck
                .filter(v => v.Title !== currentVideo.Title)
                .map(v => ({
                    video: v,
                    similarity: levenshteinDistance(currentVideo.Title, v.Title)
                }))
                .sort((a, b) => a.similarity - b.similarity); // 類似度が高い順（距離が小さい順）

            // 上位から3つ選ぶ（似ているものを優先）
            // 万が一3つ未満の場合も考慮
            const numDistractors = Math.min(3, videosWithSimilarity.length);
            const distractors = videosWithSimilarity.slice(0, numDistractors).map(item => item.video);

            // 正解と混ぜる
            const options = [...distractors, currentVideo];
            shuffleArray(options);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-white border border-gray-300 hover:bg-red-50 hover:border-red-300 p-3 rounded-lg shadow-sm transition text-sm font-medium";
                btn.innerText = opt.Title;
                btn.onclick = () => checkNormalAnswer(opt);
                container.appendChild(btn);
            });
        }

        // 配列シャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 通常モード判定
        function checkNormalAnswer(selected) {
            selectedVideo = selected;
            const isCorrect = selected.Title === currentVideo.Title;
            showResult(isCorrect);
        }

        // ハードモード判定
        function checkHardAnswer() {
            const input = document.getElementById('title-input').value;
            // 正規化（前後の空白削除、小文字化）して比較
            const normalize = (str) => str.trim().toLowerCase().replace(/\s+/g, '');
            
            // 完全一致が原則だが、使い勝手のため正規化して比較
            const isCorrect = normalize(input) === normalize(currentVideo.Title);
            showResult(isCorrect);
        }

        // 逆クイズモード：選択肢生成
        function generateReverseOptions() {
            const container = document.getElementById('reverse-options');
            container.innerHTML = '';

            // 正解タイトルとの類似度を計算して、類似したタイトルの動画を選ぶ
            const videosToCheck = filteredVideos.length >= 4 ? filteredVideos : allVideos;
            const videosWithSimilarity = videosToCheck
                .filter(v => v.Title !== currentVideo.Title)
                .map(v => ({
                    video: v,
                    similarity: levenshteinDistance(currentVideo.Title, v.Title)
                }))
                .sort((a, b) => a.similarity - b.similarity); // 類似度が高い順（距離が小さい順）

            // 類似度が高い上位3つを選択肢として使用
            const numDistractors = Math.min(3, videosWithSimilarity.length);
            const distractors = videosWithSimilarity.slice(0, numDistractors).map(item => item.video);

            // 正解と混ぜる
            const options = [...distractors, currentVideo];
            shuffleArray(options);

            // サムネをグリッド表示
            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = "cursor-pointer border-2 border-gray-300 hover:border-purple-500 rounded-lg overflow-hidden transition";
                div.innerHTML = `<img src="${opt.Thumbnail}" alt="サムネイル" class="w-full h-auto">`;
                div.onclick = () => checkReverseAnswer(opt);
                container.appendChild(div);
            });
        }

        // 逆クイズモード判定
        function checkReverseAnswer(selected) {
            selectedVideo = selected;
            const isCorrect = selected.Title === currentVideo.Title;
            showResult(isCorrect);
        }

        // ハイ＆ローモード：問題生成
        function generateHighLowQuestion() {
            // 安全性チェック：十分な動画があるか確認
            if (filteredVideos.length < 2) {
                console.error('Not enough videos for High&Low mode');
                return;
            }
            
            // 2つ目の動画をランダムに選ぶ
            let attempts = 0;
            const maxAttempts = 100;
            do {
                const randomIndex = Math.floor(Math.random() * filteredVideos.length);
                currentVideo2 = filteredVideos[randomIndex];
                attempts++;
            } while(currentVideo2.Title === currentVideo.Title && attempts < maxAttempts);

            // UI表示
            document.getElementById('highlow-video1-thumb').src = currentVideo.Thumbnail;
            document.getElementById('highlow-video1-title').innerText = currentVideo.Title;
            
            document.getElementById('highlow-video2-thumb').src = currentVideo2.Thumbnail;
            document.getElementById('highlow-video2-title').innerText = currentVideo2.Title;
        }

        // ハイ＆ローモード判定
        function checkHighLowAnswer(videoNumber) {
            const selected = (videoNumber === 1) ? currentVideo : currentVideo2;
            selectedVideo = selected;
            const otherVideo = (videoNumber === 1) ? currentVideo2 : currentVideo;
            const isCorrect = parseInt(selected.ViewCount) > parseInt(otherVideo.ViewCount);
            
            // 結果表示時に両方の再生数を表示
            showHighLowResult(isCorrect, currentVideo, currentVideo2);
        }

        // ハイ＆ローモード結果表示
        function showHighLowResult(isCorrect, video1, video2) {
            const msgEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const detailEl = document.getElementById('result-detail');
            const linkEl = document.getElementById('result-link');
            
            // 誤答セクション
            const wrongSection = document.getElementById('wrong-answer-section');
            const wrongTitleEl = document.getElementById('wrong-answer-title');
            const wrongLinkEl = document.getElementById('wrong-answer-link');

            if (isCorrect) {
                msgEl.innerText = "⭕ 正解！";
                msgEl.className = "text-3xl font-bold mb-4 text-green-600";
                wrongSection.classList.add('hidden');
            } else {
                msgEl.innerText = "❌ 残念...";
                msgEl.className = "text-3xl font-bold mb-4 text-red-600";
                
                // 選択した方を誤答として表示
                if (selectedVideo) {
                    wrongSection.classList.remove('hidden');
                    wrongTitleEl.innerText = selectedVideo.Title;
                    wrongLinkEl.href = selectedVideo.URL;
                } else {
                    wrongSection.classList.add('hidden');
                }
            }

            titleEl.innerText = "再生数比較";
            detailEl.innerHTML = `
                <p class="mb-1"><strong>${video1.Title}</strong></p>
                <p class="text-blue-600 font-bold mb-3">${parseInt(video1.ViewCount).toLocaleString()} 回</p>
                <p class="mb-1"><strong>${video2.Title}</strong></p>
                <p class="text-blue-600 font-bold">${parseInt(video2.ViewCount).toLocaleString()} 回</p>
            `;
            
            // リンクは再生数が多い方を表示（正解）
            const winnerVideo = parseInt(video1.ViewCount) > parseInt(video2.ViewCount) ? video1 : video2;
            linkEl.href = winnerVideo.URL;

            switchScreen('result');
        }

        // 結果表示
        function showResult(isCorrect) {
            const msgEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const detailEl = document.getElementById('result-detail');
            const linkEl = document.getElementById('result-link');
            
            // 誤答セクション
            const wrongSection = document.getElementById('wrong-answer-section');
            const wrongTitleEl = document.getElementById('wrong-answer-title');
            const wrongLinkEl = document.getElementById('wrong-answer-link');

            if (isCorrect) {
                msgEl.innerText = "⭕ 正解！";
                msgEl.className = "text-3xl font-bold mb-4 text-green-600";
                wrongSection.classList.add('hidden');
            } else {
                msgEl.innerText = "❌ 残念...";
                msgEl.className = "text-3xl font-bold mb-4 text-red-600";
                
                // 誤答を表示（ハードモード以外）
                if (selectedVideo && selectedVideo !== currentVideo) {
                    wrongSection.classList.remove('hidden');
                    wrongTitleEl.innerText = selectedVideo.Title;
                    wrongLinkEl.href = selectedVideo.URL;
                } else {
                    wrongSection.classList.add('hidden');
                }
            }

            titleEl.innerText = currentVideo.Title;
            detailEl.innerHTML = ''; // クリア（ハイ＆ローモード以外では空）
            linkEl.href = currentVideo.URL;

            switchScreen('result');
        }

        function backToMenu() {
            switchScreen('start');
        }
    </script>
</body>
</html>