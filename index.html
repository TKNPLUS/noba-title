<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTuberサムネイルクイズ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen flex flex-col items-center justify-center p-4">

    <div class="max-w-2xl w-full bg-white rounded-xl shadow-lg overflow-hidden p-6">
        
        <header class="mb-6 text-center border-b pb-4">
            <h1 class="text-2xl font-bold text-red-600">YouTube サムネイルクイズ</h1>
            <p class="text-sm text-gray-500 mt-1">サムネを見て動画タイトルを当てよう！</p>
        </header>

        <div id="loading-screen" class="text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-600 mx-auto mb-4"></div>
            <p>ランキングデータを読み込み中...</p>
        </div>

        <div id="error-screen" class="hidden text-center py-10 text-red-600">
            <p id="error-message">データの読み込みに失敗しました。</p>
            <p class="text-sm mt-2 text-gray-500">csvファイルが同じフォルダにあるか確認してください。</p>
        </div>

        <div id="start-screen" class="hidden fade-in space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h2 class="font-bold mb-2">① 出題範囲（ランキング）</h2>
                <input type="range" id="rank-range" min="10" max="100" value="50" class="w-full h-2 bg-blue-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-sm mt-1">
                    <span>上位10% (有名)</span>
                    <span id="rank-value" class="font-bold text-blue-600">上位 50%</span>
                    <span>100% (マニア)</span>
                </div>
                <p class="text-xs text-gray-500 mt-2 text-center">
                    対象動画数: <span id="video-count-display">0</span> 本 / 全 <span id="total-video-count">0</span> 本
                </p>
            </div>

            <div class="bg-yellow-50 p-4 rounded-lg">
                <h2 class="font-bold mb-2">② ゲームモード</h2>
                <div class="space-y-2">
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="normal" checked class="mr-2">
                        <span>通常モード（サムネ → タイトル選択）</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="hard" class="mr-2">
                        <span>ハードモード（サムネ → タイトル入力）</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="reverse" class="mr-2">
                        <span>逆クイズ（タイトル → サムネ選択）</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="mode" value="higher-lower" class="mr-2">
                        <span>ハイ＆ロー（再生数当て）</span>
                    </label>
                </div>
            </div>

            <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow transition transform hover:scale-105">
                ゲームスタート
            </button>
        </div>

        <div id="quiz-screen" class="hidden fade-in">
            <div class="mb-4 flex justify-between items-center text-sm text-gray-500">
                <span id="quiz-rank-info">Rank: ???</span>
                <span class="bg-gray-200 px-2 py-1 rounded">View: <span id="quiz-view-count">0</span></span>
            </div>

            <div id="quiz-image-container" class="flex justify-center mb-6">
                <img id="quiz-image" src="" alt="Thumbnail" class="rounded-lg shadow-md max-h-64 object-cover border-2 border-gray-200">
            </div>

            <div id="normal-options" class="grid grid-cols-1 gap-3">
                </div>

            <div id="hard-input-area" class="hidden flex flex-col gap-3">
                <input type="text" id="title-input" placeholder="動画タイトルを入力..." class="border-2 border-gray-300 p-3 rounded-lg w-full focus:outline-none focus:border-red-500">
                <button onclick="checkHardAnswer()" class="bg-red-600 text-white font-bold py-2 rounded-lg hover:bg-red-700">回答する</button>
                <p class="text-xs text-gray-400 text-center">※スペースや大文字小文字は無視されます</p>
            </div>

            <!-- 逆クイズ用UI -->
            <div id="reverse-quiz-area" class="hidden">
                <h3 class="font-bold text-lg mb-4 text-center">このタイトルのサムネはどれ？</h3>
                <div class="bg-blue-100 p-4 rounded-lg mb-4">
                    <p id="reverse-title-display" class="text-center font-bold"></p>
                </div>
                <div id="reverse-options" class="grid grid-cols-2 gap-3"></div>
            </div>

            <!-- ハイ＆ロー用UI -->
            <div id="higher-lower-area" class="hidden space-y-4">
                <h3 class="font-bold text-lg text-center">どちらの再生数が多い？</h3>
                
                <div class="border-2 border-blue-400 p-4 rounded-lg bg-blue-50">
                    <img id="hl-thumbnail-1" class="w-full rounded mb-2" alt="動画1">
                    <p id="hl-title-1" class="font-bold text-sm mb-2"></p>
                    <p id="hl-views-1" class="text-red-600 font-bold"></p>
                </div>
                
                <div class="text-center text-2xl font-bold">VS</div>
                
                <div class="border-2 border-gray-300 p-4 rounded-lg">
                    <img id="hl-thumbnail-2" class="w-full rounded mb-2" alt="動画2">
                    <p id="hl-title-2" class="font-bold text-sm mb-2"></p>
                    <p id="hl-views-2" class="text-gray-400 font-bold">??? 回</p>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="checkHigherLower('higher')" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg">
                        ⬆️ 多い
                    </button>
                    <button onclick="checkHigherLower('lower')" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg">
                        ⬇️ 少ない
                    </button>
                </div>
            </div>
        </div>

        <div id="result-screen" class="hidden fade-in text-center">
            <h2 id="result-message" class="text-3xl font-bold mb-4"></h2>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-6 text-left">
                <p class="text-xs text-gray-500 mb-1">正解の動画</p>
                <p id="result-title" class="font-bold text-lg mb-2 text-gray-900"></p>
                <a id="result-link" href="#" target="_blank" class="text-blue-600 underline text-sm hover:text-blue-800 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/></svg>
                    YouTubeで見る
                </a>
            </div>

            <div class="flex gap-4">
                <button onclick="backToMenu()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 rounded-lg">
                    メニューに戻る
                </button>
                <button onclick="nextQuestion()" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-2 rounded-lg">
                    次の問題
                </button>
            </div>
        </div>

    </div>

    <script>
        // 設定
        const CSV_FILE = 'all_videos_ranking.csv';
        
        // 状態変数
        let allVideos = [];
        let filteredVideos = [];
        let currentVideo = null;
        let currentMode = 'normal';
        let higherLowerVideos = []; // ハイ＆ロー用の2つの動画

        // DOM要素
        const screens = {
            loading: document.getElementById('loading-screen'),
            error: document.getElementById('error-screen'),
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen')
        };

        // 初期化：CSV読み込み
        window.onload = function() {
            Papa.parse(CSV_FILE, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        allVideos = results.data;
                        initMenu();
                    } else {
                        showError("データが空です。");
                    }
                },
                error: function(err) {
                    showError("CSVの読み込みに失敗しました。" + err);
                }
            });
        };

        function showError(msg) {
            screens.loading.classList.add('hidden');
            screens.error.classList.remove('hidden');
            document.getElementById('error-message').innerText = msg;
        }

        function switchScreen(screenName) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        // メニューの初期化
        function initMenu() {
            const total = allVideos.length;
            document.getElementById('total-video-count').innerText = total;
            
            const slider = document.getElementById('rank-range');
            const display = document.getElementById('rank-value');
            const countDisplay = document.getElementById('video-count-display');

            function updateCount() {
                const percent = slider.value;
                display.innerText = `上位 ${percent}%`;
                const count = Math.ceil(total * (percent / 100));
                countDisplay.innerText = count;
            }

            slider.addEventListener('input', updateCount);
            updateCount(); // 初回実行
            switchScreen('start');
        }

        // ゲーム開始
        function startGame() {
            const percent = document.getElementById('rank-range').value;
            const count = Math.ceil(allVideos.length * (percent / 100));
            // 上位ランク順（CSVが既にソートされている前提、またはRank列でソート）
            // CSVはRank順と仮定するが、念の為Rankでソート
            allVideos.sort((a, b) => parseInt(a.Rank) - parseInt(b.Rank));
            filteredVideos = allVideos.slice(0, count);

            const modeRadios = document.getElementsByName('mode');
            for(const radio of modeRadios) {
                if(radio.checked) currentMode = radio.value;
            }

            nextQuestion();
        }

        // 次の問題を出題
        function nextQuestion() {
            if (filteredVideos.length === 0) return;

            // ランダムに1つ選ぶ
            const randomIndex = Math.floor(Math.random() * filteredVideos.length);
            currentVideo = filteredVideos[randomIndex];

            // 画面セットアップ
            document.getElementById('quiz-image').src = currentVideo.Thumbnail;
            document.getElementById('quiz-rank-info').innerText = `Rank: ${currentVideo.Rank}`;
            document.getElementById('quiz-view-count').innerText = parseInt(currentVideo.ViewCount).toLocaleString();
            
            // モード別表示
            const normalOptions = document.getElementById('normal-options');
            const hardInput = document.getElementById('hard-input-area');
            const reverseArea = document.getElementById('reverse-quiz-area');
            const higherLowerArea = document.getElementById('higher-lower-area');
            const quizImageContainer = document.getElementById('quiz-image-container');
            const titleInput = document.getElementById('title-input');

            // 全てを非表示にしてから、必要なものだけ表示
            normalOptions.classList.add('hidden');
            hardInput.classList.add('hidden');
            reverseArea.classList.add('hidden');
            higherLowerArea.classList.add('hidden');

            if (currentMode === 'normal') {
                normalOptions.classList.remove('hidden');
                quizImageContainer.classList.remove('hidden');
                generateNormalOptions();
            } else if (currentMode === 'reverse') {
                reverseArea.classList.remove('hidden');
                quizImageContainer.classList.add('hidden');
                generateReverseOptions();
            } else if (currentMode === 'higher-lower') {
                higherLowerArea.classList.remove('hidden');
                quizImageContainer.classList.add('hidden');
                generateHigherLowerQuestion();
            } else {
                // hard モード
                hardInput.classList.remove('hidden');
                quizImageContainer.classList.remove('hidden');
                titleInput.value = ''; // クリア
                // Enterキーで回答できるようにする
                titleInput.onkeydown = (e) => { if(e.key === 'Enter') checkHardAnswer(); };
            }

            switchScreen('quiz');
        }

        // Levenshtein距離を計算（文字列の類似度）
        function levenshteinDistance(str1, str2) {
            // 入力検証
            if (str1 == null || str2 == null) return Infinity;
            str1 = String(str1);
            str2 = String(str2);
            
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // 通常モード：選択肢生成（改良版）
        function generateNormalOptions() {
            const container = document.getElementById('normal-options');
            container.innerHTML = '';

            // 正解タイトルとの類似度を計算
            // パフォーマンス最適化：filteredVideosを使用（allVideosより少ない）
            const videosToCheck = filteredVideos.length >= 4 ? filteredVideos : allVideos;
            const videosWithSimilarity = videosToCheck
                .filter(v => v.Title !== currentVideo.Title)
                .map(v => ({
                    video: v,
                    similarity: levenshteinDistance(currentVideo.Title, v.Title)
                }))
                .sort((a, b) => a.similarity - b.similarity); // 類似度が高い順（距離が小さい順）

            // 上位から3つ選ぶ（似ているものを優先）
            // 万が一3つ未満の場合も考慮
            const numDistractors = Math.min(3, videosWithSimilarity.length);
            const distractors = videosWithSimilarity.slice(0, numDistractors).map(item => item.video);

            // 正解と混ぜる
            const options = [...distractors, currentVideo];
            shuffleArray(options);

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left bg-white border border-gray-300 hover:bg-red-50 hover:border-red-300 p-3 rounded-lg shadow-sm transition text-sm font-medium";
                btn.innerText = opt.Title;
                btn.onclick = () => checkNormalAnswer(opt);
                container.appendChild(btn);
            });
        }

        // 配列シャッフル
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 通常モード判定
        function checkNormalAnswer(selectedVideo) {
            const isCorrect = selectedVideo.Title === currentVideo.Title;
            showResult(isCorrect);
        }

        // ハードモード判定
        function checkHardAnswer() {
            const input = document.getElementById('title-input').value;
            // 正規化（前後の空白削除、小文字化）して比較
            const normalize = (str) => str.trim().toLowerCase().replace(/\s+/g, '');
            
            // 完全一致が原則だが、使い勝手のため正規化して比較
            const isCorrect = normalize(input) === normalize(currentVideo.Title);
            showResult(isCorrect);
        }

        // 逆クイズの選択肢生成
        function generateReverseOptions() {
            const container = document.getElementById('reverse-options');
            container.innerHTML = '';
            
            // タイトルを表示
            document.getElementById('reverse-title-display').innerText = currentVideo.Title;

            // 正解以外の画像を3つ選ぶ
            const distractors = [];
            const availableVideos = filteredVideos.filter(v => v.Thumbnail !== currentVideo.Thumbnail);
            
            while(distractors.length < 3 && availableVideos.length > 0) {
                const randomIdx = Math.floor(Math.random() * availableVideos.length);
                const selected = availableVideos[randomIdx];
                if (!distractors.find(d => d.Thumbnail === selected.Thumbnail)) {
                    distractors.push(selected);
                }
                availableVideos.splice(randomIdx, 1);
            }

            const options = [...distractors, currentVideo];
            shuffleArray(options);

            options.forEach(opt => {
                const imgBtn = document.createElement('button');
                imgBtn.className = "border-2 border-gray-300 hover:border-red-400 rounded overflow-hidden transition";
                imgBtn.onclick = () => checkReverseAnswer(opt);
                
                const img = document.createElement('img');
                img.src = opt.Thumbnail;
                img.className = "w-full h-auto";
                img.alt = "選択肢";
                
                imgBtn.appendChild(img);
                container.appendChild(imgBtn);
            });
        }

        // 逆クイズの判定
        function checkReverseAnswer(selectedVideo) {
            const isCorrect = selectedVideo.Thumbnail === currentVideo.Thumbnail;
            showResult(isCorrect);
        }

        // ハイ＆ローの問題生成
        function generateHigherLowerQuestion() {
            // ランダムに2つ選ぶ
            const video1 = filteredVideos[Math.floor(Math.random() * filteredVideos.length)];
            let video2;
            do {
                video2 = filteredVideos[Math.floor(Math.random() * filteredVideos.length)];
            } while (video2.VideoID === video1.VideoID);
            
            higherLowerVideos = [video1, video2];
            
            // UI表示
            document.getElementById('hl-thumbnail-1').src = video1.Thumbnail;
            document.getElementById('hl-title-1').innerText = video1.Title;
            document.getElementById('hl-views-1').innerText = parseInt(video1.ViewCount).toLocaleString() + ' 回';
            
            document.getElementById('hl-thumbnail-2').src = video2.Thumbnail;
            document.getElementById('hl-title-2').innerText = video2.Title;
            document.getElementById('hl-views-2').innerText = '??? 回';
        }

        // ハイ＆ロー判定
        function checkHigherLower(choice) {
            const video1Views = parseInt(higherLowerVideos[0].ViewCount);
            const video2Views = parseInt(higherLowerVideos[1].ViewCount);
            
            let isCorrect = false;
            if (choice === 'higher' && video2Views > video1Views) {
                isCorrect = true;
            } else if (choice === 'lower' && video2Views < video1Views) {
                isCorrect = true;
            }
            
            // 正解を表示
            document.getElementById('hl-views-2').innerText = parseInt(higherLowerVideos[1].ViewCount).toLocaleString() + ' 回';
            
            showResult(isCorrect);
        }

        // 結果表示
        function showResult(isCorrect) {
            const msgEl = document.getElementById('result-message');
            const titleEl = document.getElementById('result-title');
            const linkEl = document.getElementById('result-link');

            if (isCorrect) {
                msgEl.innerText = "⭕ 正解！";
                msgEl.className = "text-3xl font-bold mb-4 text-green-600";
            } else {
                msgEl.innerText = "❌ 残念...";
                msgEl.className = "text-3xl font-bold mb-4 text-red-600";
            }

            titleEl.innerText = currentVideo.Title;
            linkEl.href = currentVideo.URL;

            switchScreen('result');
        }

        function backToMenu() {
            switchScreen('start');
        }
    </script>
</body>
</html>